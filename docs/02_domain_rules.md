# Phase 0 - Domain Rules 정의

본 문서는 StratEx 거래소의 핵심 도메인 규칙을 정의한다.  
거래소 로직의 일관성과 데이터 무결성을 유지하기 위한 기준 문서이다.

---

## 1. 자산 구조

모든 사용자 자산은 다음 두 가지 상태로 관리한다.

- available : 사용 가능한 자산
- locked : 주문으로 인해 잠긴 자산

### 1.1 자산 무결성 규칙

`available + locked = 총 보유 자산`

이 관계는 항상 유지되어야 한다.

---

## 2. 주문 생성 규칙

### 2.1 매수 주문 생성 시

- 매수에 필요한 금액(KRW)을 available에서 locked로 이동
- available 잔액이 부족하면 주문 생성 불가

예시:

보유 KRW: 1,000,000

700,000원 매수 주문 생성 시:

- available = 300,000
- locked = 700,000

---

### 2.2 매도 주문 생성 시

- 매도 수량(코인)을 available에서 locked로 이동
- 보유 수량이 부족하면 주문 생성 불가

---

## 3. 주문 취소 규칙

- 취소된 주문의 locked 자산은 available로 복구
- 주문 상태는 CANCELED로 변경

---

## 4. 체결 규칙

### 4.1 체결 발생 시

매수자:

- locked KRW 감소
- 코인 available 증가

매도자:

- locked 코인 감소
- KRW available 증가

---

### 4.2 부분 체결

- 체결된 수량만큼 locked 감소
- 남은 수량은 계속 locked 상태 유지
- 주문 상태는 PARTIALLY_FILLED
- filled_quantity를 누적 관리한다.

---

## 5. 주문 상태 정의

- OPEN : 체결 대기
- PARTIALLY_FILLED : 일부 체결
- FILLED : 전량 체결
- CANCELED : 사용자 취소
- REJECTED : 정책 위반으로 거부

---

## 6. 매칭 우선순위 규칙

1. 가격 우선
2. 동일 가격일 경우 시간 우선

---

## 7. Price Band 정책 규칙 (Reject Policy)

### 7.1 주문 생성 시

허용 범위:

`허용 범위 = Reference Price ± k%`

- 범위를 벗어나는 주문은 REJECTED 처리

---

### 7.2 체결 직전 검증

- 체결 가격이 허용 범위를 벗어나면 체결 불가 처리

---

## 8. 호가 단위(Tick Size) 정책

본 거래소는 가격 구간별로 허용하는 호가 단위를 다르게 적용한다.  
사용자가 입력한 주문 가격은 아래 tick size 규칙을 만족해야 하며, 위반 시 주문은 REJECTED 처리한다.

### 8.1 가격 구간별 tick size

| 가격 구간 | tick size | 허용 소수점 |
|----------|----------|------------|
| price ≥ 100 | 1 | 0자리 |
| 10 ≤ price < 100 | 0.1 | 1자리 |
| 1 ≤ price < 10 | 0.01 | 2자리 |
| price < 1 | 0.001 | 3자리 |

### 8.2 검증 규칙

주문 가격 `P`가 해당 구간의 tick size `T`에 대해 아래 조건을 만족해야 한다.

- `P % T == 0` 이어야 함
- 만족하지 않으면 REJECTED

예시:

- price = 15.2 (구간: 10~100, tick=0.1) → 허용
- price = 15.23 (tick=0.1) → REJECTED
- price = 0.123 (구간: <1, tick=0.001) → 허용
- price = 0.1234 (tick=0.001) → REJECTED

---

## 9. 금액/수량 데이터 타입 원칙

- 금액/가격/수량은 부동소수점(float/double) 사용 금지
- BigDecimal 사용
- DB는 decimal(precision, scale) 형태로 관리하며, 가격은 최대 3자리 소수까지 저장 가능하도록 설계한다.
    - 예: price: DECIMAL(19,3), quantity: DECIMAL(19,8)

---

## 10. 동시성 처리 원칙

- 주문 생성 / 취소 / 체결은 트랜잭션 단위로 처리
- 동일 사용자 자산에 대한 동시 수정은 DB 레벨에서 제어
- 잔고 무결성이 깨지지 않도록 보장

---

## 11. 시스템 장애 대응 원칙

### 11.1 Reference Price 수집 실패 시

- 최근 값 캐싱 유지
- 일정 시간 초과 시 신규 주문 제한(거래 제한 모드)
- 사용자에게 안내 메시지 표시

---

본 문서는 거래소 핵심 로직 구현의 기준 문서로 사용된다.